# 935k 实际使用指南（针对厂商数据格式）

## 🎯 你的数据格式

根据你提供的实际数据，格式如下：

```csv
TargetID,000536.AVG_Beta,000537.AVG_Beta
cg00000029_TC21,0.4630385,0.4062999
cg00000109_TC21,0.8233373,0.8394986
cg00000155_BC21,0.8882958,0.8735513
```

**特点**：
- 行 = 探针（如 `cg00000029_TC21`）
- 列 = 样本（如 `000536.AVG_Beta`）
- 探针ID有后缀（`_TC21`, `_BC21` 等）
- 样本ID有后缀（`.AVG_Beta`）

## ✅ 好消息

**CpGPT 完全支持这种格式！**

虽然需要转换，但我们提供了自动转换工具，非常简单。

## 🚀 使用方法（2步）

### 步骤 1: 转换数据格式

```bash
python examples/convert_935k_format.py "Sample Methylation Profile.csv"
```

**转换脚本会自动**：
- ✅ 去除探针ID后缀（`cg00000029_TC21` → `cg00000029`）
- ✅ 去除样本ID后缀（`000536.AVG_Beta` → `000536`）
- ✅ 转置数据（行列互换）
- ✅ 处理重复探针（取平均值）
- ✅ 处理空值（保留为NaN）
- ✅ 保存为Arrow格式

**输出**：`Sample Methylation Profile.arrow`

### 步骤 2: 运行预测

```bash
# 编辑脚本，修改数据路径
# RAW_DATA_PATH = "./data/Sample Methylation Profile.arrow"

python examples/935k_simple_prediction.py
```

## 📊 关于探针后缀

### 为什么有 `_TC21`, `_BC21` 等后缀？

EPICv2 芯片对某些CpG位点使用了多个探针：
- `_TC21` - Type I 探针，红色通道
- `_BC21` - Type I 探针，绿色通道  
- `_BC11` - Type II 探针

### CpGPT 如何处理？

**自动处理！** 在源码中（`illumina_methylation_prober.py` 第332行）：

```python
# Collapase probe IDs that map to the same locus in EPICv2
manifest_df["Probe_ID"] = manifest_df["Probe_ID"].str.split("_").str[0]
```

这意味着：
- `cg00000029_TC21` → `cg00000029`
- `cg00000029_BC21` → `cg00000029`
- 如果有重复，取平均值

**你不需要担心这个问题，转换脚本会自动处理！**

## 🔍 关于空值

### 你的数据有空值吗？

**没问题！** CpGPT 可以处理空值。

在预测过程中：
1. 空值会被保留为 NaN
2. 模型会自动忽略这些位置
3. 使用其他可用的探针进行预测
4. 不会影响最终结果

### 建议

- ✅ 如果某个探针在所有样本中都是空值 → 可以删除（转换脚本会保留）
- ✅ 如果某个样本的大部分探针都是空值 → 检查数据质量
- ✅ 少量空值（<10%）→ 完全没问题

## 📝 完整示例

### 示例 1: 基本使用

```bash
# 1. 转换数据
python examples/convert_935k_format.py "Sample Methylation Profile.csv"

# 2. 运行预测（使用默认配置）
python examples/935k_simple_prediction.py
```

### 示例 2: 自定义输出路径

```bash
# 转换时指定输出文件名
python examples/convert_935k_format.py \
    "Sample Methylation Profile.csv" \
    -o "./data/my_935k_data.arrow"
```

### 示例 3: 只运行部分预测

编辑 `examples/935k_simple_prediction.py`：

```python
# 选择要运行的预测
PREDICT_AGE = True          # 年龄预测
PREDICT_CANCER = False      # 跳过癌症预测
PREDICT_CLOCKS = True       # 表观遗传时钟
PREDICT_PROTEINS = False    # 跳过蛋白质预测
```

## 🔧 故障排除

### 问题 1: 找不到转换脚本

**解决方案**：
```bash
# 确保在 CpGPT 项目根目录
cd /path/to/CpGPT

# 运行转换脚本
python examples/convert_935k_format.py "你的文件.csv"
```

### 问题 2: 转换后数据不对

**检查**：
```python
import pandas as pd

df = pd.read_feather("Sample Methylation Profile.arrow")
print("形状:", df.shape)
print("第一列:", df.columns[0])  # 应该是 'sample_id'
print("前5列:", df.columns[:5].tolist())
print("\n前3行:")
print(df.head(3))
```

**期望输出**：
- 第一列名称：`sample_id`
- 其他列：探针ID（如 `cg00000029`，无后缀）
- 行数 = 样本数
- 列数 = 探针数 + 1

### 问题 3: 内存不足

**解决方案**：
在 `935k_simple_prediction.py` 中：
```python
MAX_INPUT_LENGTH = 15000  # 从 30000 降低
USE_CPU = True            # 使用 CPU
```

## 📚 详细文档

- **数据格式详解**: [docs/935k_ACTUAL_FORMAT_GUIDE.md](docs/935k_ACTUAL_FORMAT_GUIDE.md)
- **转换脚本源码**: [examples/convert_935k_format.py](examples/convert_935k_format.py)
- **预测脚本源码**: [examples/935k_simple_prediction.py](examples/935k_simple_prediction.py)

## ❓ 常见问题

### Q: 为什么不能直接用原始CSV？

**A**: 因为数据方向不对：
- 你的数据：行=探针，列=样本
- CpGPT需要：行=样本，列=探针

必须转置（行列互换）。

### Q: 转换会丢失数据吗？

**A**: 不会！转换只是改变格式：
- 所有Beta值都保留
- 空值也保留
- 只是去除了不必要的后缀

### Q: 重复的探针怎么办？

**A**: 自动取平均值。例如：
- `cg00000029_TC21` = 0.46
- `cg00000029_BC21` = 0.48
- 结果：`cg00000029` = 0.47

### Q: 需要多长时间？

**A**: 
- 转换：几秒到几分钟（取决于样本数）
- 预测：每个模型 5-30 分钟（取决于样本数和硬件）

## ✅ 检查清单

开始前确保：

- [ ] 已安装 CpGPT (`poetry install`)
- [ ] 已配置 AWS CLI
- [ ] 数据文件存在
- [ ] 数据格式是厂商格式（行=探针，列=样本）
- [ ] 已运行转换脚本
- [ ] 转换后的 Arrow 文件存在
- [ ] 已修改预测脚本中的数据路径

## 🎯 总结

**关键点**：
1. ✅ 你的数据格式是标准的 EPICv2 厂商格式
2. ✅ CpGPT 完全支持，但需要转换
3. ✅ 探针后缀会自动处理
4. ✅ 空值可以处理
5. ✅ 使用转换脚本，一键完成

**两步搞定**：
```bash
# 1. 转换
python examples/convert_935k_format.py "你的文件.csv"

# 2. 预测
python examples/935k_simple_prediction.py
```

**就这么简单！** 🚀

---

**需要帮助？**
- 📖 查看详细文档：`docs/935k_ACTUAL_FORMAT_GUIDE.md`
- 📧 联系：lucas_camillo@alumni.brown.edu

