# 935k 数据格式说明

## 🎯 你的问题

你提到实际的 935k 数据格式是：

```csv
TargetID,000536.AVG_Beta,000537.AVG_Beta 
cg00000029_TC21,0.4630385,0.4062999 
cg00000109_TC21,0.8233373,0.8394986
cg00000155_BC21,0.8882958,0.8735513 
cg00000158_BC21,0.9374912,0.9106941
```

**关键特征**：
1. 行 = 探针（如 `cg00000029_TC21`）
2. 列 = 样本（如 `000536.AVG_Beta`）
3. 探针ID有后缀（`_TC21`, `_BC21` 等）
4. 样本ID有后缀（`.AVG_Beta`）
5. 可能有空值

## ✅ 答案：需要转换，但很简单！

### 为什么需要转换？

**1. 探针ID后缀问题**

虽然 CpGPT 的源码中**已经自动处理**探针后缀：

```python
# 在 illumina_methylation_prober.py 第332行
manifest_df["Probe_ID"] = manifest_df["Probe_ID"].str.split("_").str[0]
```

这意味着：
- `cg00000029_TC21` → 自动变成 `cg00000029`
- `cg00000029_BC21` → 自动变成 `cg00000029`

**但是**，这个处理是在 CpGPT 读取 manifest 文件时进行的，你的数据需要先转换成正确的格式。

**2. 数据方向问题**

- **你的数据**：行=探针，列=样本（转置的）
- **CpGPT需要**：行=样本，列=探针

必须转置（行列互换）！

**3. 列名后缀问题**

- **你的列名**：`000536.AVG_Beta`
- **CpGPT需要**：`000536`

需要去除后缀。

## 🚀 解决方案：使用转换工具

我们提供了专门的转换工具，一键完成所有转换：

```bash
python examples/convert_935k_format.py "Sample Methylation Profile.csv"
```

**转换工具会自动**：
1. ✅ 去除探针ID后缀（`cg00000029_TC21` → `cg00000029`）
2. ✅ 去除样本ID后缀（`000536.AVG_Beta` → `000536`）
3. ✅ 转置数据（行列互换）
4. ✅ 处理重复探针（取平均值）
5. ✅ 保留空值（作为 NaN）
6. ✅ 保存为 Arrow 格式

## 📊 关于探针后缀的详细说明

### 为什么有 `_TC21`, `_BC21` 等后缀？

EPICv2 芯片对某些 CpG 位点使用了**多个探针**来提高准确性：

- `_TC21` - Type I 探针，红色通道
- `_BC21` - Type I 探针，绿色通道
- `_BC11` - Type II 探针

例如：
- `cg00000029_TC21` 和 `cg00000029_BC21` 都测量同一个位点 `cg00000029`

### CpGPT 如何处理？

**自动合并！**

1. 转换工具去除后缀：
   - `cg00000029_TC21` → `cg00000029`
   - `cg00000029_BC21` → `cg00000029`

2. 如果有重复，取平均值：
   - `cg00000029_TC21` = 0.46
   - `cg00000029_BC21` = 0.48
   - **结果**：`cg00000029` = 0.47

3. CpGPT 使用基因组位置而非探针ID：
   - `cg00000029` → 基因组位置（如 `chr1:12345`）
   - 使用 DNA 序列嵌入进行预测

## 🔍 关于空值

### 空值会影响预测吗？

**不会！** CpGPT 可以处理空值。

**处理方式**：
1. 空值保留为 NaN
2. 模型自动忽略这些位置
3. 使用其他可用的探针进行预测
4. 不影响最终结果

**建议**：
- ✅ 少量空值（<10%）→ 完全没问题
- ⚠️ 大量空值（>50%）→ 检查数据质量
- ❌ 某个样本全是空值 → 无法预测该样本

## 📝 完整使用流程

### 步骤 1: 转换数据

```bash
python examples/convert_935k_format.py "Sample Methylation Profile.csv"
```

**输出**：`Sample Methylation Profile.arrow`

### 步骤 2: 运行预测

```bash
# 编辑脚本，修改数据路径
# RAW_DATA_PATH = "./data/Sample Methylation Profile.arrow"

python examples/935k_simple_prediction.py
```

## 🔧 技术细节

### 转换前后对比

**转换前（你的原始数据）**：
```csv
TargetID,000536.AVG_Beta,000537.AVG_Beta
cg00000029_TC21,0.4630385,0.4062999
cg00000109_TC21,0.8233373,0.8394986
```
- 形状：(探针数, 样本数+1)
- 行 = 探针
- 列 = 样本

**转换后（CpGPT格式）**：
```csv
sample_id,cg00000029,cg00000109
000536,0.4630385,0.8233373
000537,0.4062999,0.8394986
```
- 形状：(样本数, 探针数+1)
- 行 = 样本
- 列 = 探针

### CpGPT 的数据处理流程

```
你的CSV数据
    ↓
转换工具（convert_935k_format.py）
    ├─ 去除探针ID后缀
    ├─ 去除样本ID后缀
    ├─ 转置数据
    ├─ 处理重复探针
    └─ 保存为Arrow格式
    ↓
Arrow 文件
    ↓
CpGPT 数据处理（cpgpt_datasaver.py）
    ├─ 读取 Arrow 文件
    ├─ 探针ID → 基因组位置（使用 EPICv2 manifest）
    ├─ 基因组位置 → DNA 序列嵌入
    └─ 过滤匹配模型词汇表的位点
    ↓
CpGPT 模型推理
    ↓
预测结果
```

## ❓ 常见问题

### Q1: 为什么不能直接用原始CSV？

**A**: 因为：
1. 数据方向不对（需要转置）
2. 列名有后缀（需要清理）
3. CpGPT 需要 Arrow 格式

### Q2: 转换会丢失数据吗？

**A**: 不会！
- 所有 Beta 值都保留
- 空值也保留
- 只是改变格式和去除后缀

### Q3: 重复的探针怎么办？

**A**: 自动取平均值（标准做法）

### Q4: 芯片出来的原始数据能直接用吗？

**A**: 不能直接用，但转换很简单：
```bash
python examples/convert_935k_format.py "你的文件.csv"
```

## 🎯 总结

### 关键点

1. ✅ **CpGPT 支持 EPICv2/935k**
2. ✅ **探针后缀会自动处理**（在 manifest 中）
3. ⚠️ **但你的数据需要先转换格式**
4. ✅ **空值可以处理**
5. ✅ **转换工具一键完成**

### 为什么需要转换？

| 问题 | 你的数据 | CpGPT需要 | 解决方案 |
|------|---------|----------|---------|
| 数据方向 | 行=探针 | 行=样本 | 转置 |
| 探针ID | `cg00000029_TC21` | `cg00000029` | 去除后缀 |
| 样本ID | `000536.AVG_Beta` | `000536` | 去除后缀 |
| 文件格式 | CSV | Arrow | 转换格式 |

### 两步搞定

```bash
# 1. 转换
python examples/convert_935k_format.py "你的文件.csv"

# 2. 预测
python examples/935k_simple_prediction.py
```

**就这么简单！** 🚀

---

**详细文档**：
- [实际使用指南](935k_实际使用指南.md)
- [数据格式详解](docs/935k_ACTUAL_FORMAT_GUIDE.md)
- [转换工具源码](examples/convert_935k_format.py)

