# 935k CSV数据支持说明

## 📋 更新内容

现在 `examples/935k_zero_shot_inference.py` 已经支持**CSV格式**的935k甲基化数据输入！

### ✨ 新增功能

1. **自动格式检测和转换**
   - 自动识别CSV格式
   - 自动转换为Arrow格式进行处理
   - 保留原始CSV文件不变

2. **完整的可视化和报告**
   - 4种专业的统计图表
   - 交互式HTML分析报告
   - 详细的中文解读和临床意义说明

3. **数据验证工具**
   - 验证数据格式是否正确
   - 检查Beta值范围
   - 统计缺失值情况

---

## 🚀 快速开始

### 步骤1: 准备CSV数据

将您的935k甲基化数据保存为CSV格式：

```csv
sample_id,cg00000029,cg00000108,cg00000109,cg00000165,...
sample_001,0.234,0.567,0.891,0.123,...
sample_002,0.345,0.678,0.912,0.234,...
sample_003,0.456,0.789,0.123,0.345,...
```

**要求：**
- 第一列：样本ID
- 其他列：CpG位点（列名如 `cg00000029`）
- 值：Beta值（0-1范围）

### 步骤2: 验证数据格式（推荐）

```bash
python examples/validate_935k_data.py ./data/935k_samples.csv
```

这会检查：
- ✅ 文件是否存在
- ✅ 列名格式是否正确
- ✅ Beta值范围是否正常
- ✅ 缺失值比例
- ✅ 数据基本统计

### 步骤3: 运行零样本推理

```bash
python examples/935k_zero_shot_inference.py
```

脚本会自动：
1. 检测CSV格式并转换为Arrow
2. 下载预训练模型和依赖
3. 处理数据并执行预测
4. 生成可视化图表
5. 生成HTML分析报告

### 步骤4: 查看结果

```bash
# 在浏览器中打开报告
open results/935k_predictions/analysis_report.html
```

---

## 📁 输出文件

运行完成后，您将获得：

```
results/935k_predictions/
├── age_predictions.csv              # 年龄预测结果
├── cancer_predictions.csv           # 癌症预测结果
├── combined_predictions.csv         # 综合结果
├── analysis_report.html             # 📄 完整HTML分析报告
└── figures/                         # 📊 可视化图表
    ├── age_distribution.png         # 年龄分布图
    ├── cancer_distribution.png      # 癌症分布图
    ├── age_cancer_correlation.png   # 相关性分析图
    └── summary_statistics.png       # 统计摘要图
```

---

## 📊 可视化内容

### 1. 年龄分布图
- 直方图：显示年龄分布
- 箱线图：显示统计特征（中位数、四分位数等）

### 2. 癌症分布图
- 概率分布直方图
- 分类饼图（正常 vs 癌症）
- 风险分层柱状图（低/中低/中高/高风险）

### 3. 年龄-癌症相关性图
- 散点图：年龄 vs 癌症概率
- 柱状图：不同年龄组的癌症预测率

### 4. 统计摘要图
- 年龄统计
- 癌症统计
- 风险分层
- 年龄密度分布
- 癌症概率分布（按年龄着色）
- 高风险样本列表

---

## 📖 HTML报告内容

完整的HTML报告包含：

1. **执行摘要**
   - 总样本数
   - 平均年龄
   - 癌症预测率
   - 高风险样本数

2. **年龄预测分析**
   - 详细统计表格
   - 可视化图表
   - 结果解读和临床意义

3. **癌症预测分析**
   - 预测结果分布
   - 风险分层统计
   - 高风险样本列表（如有）

4. **年龄与癌症相关性**
   - 不同年龄组的癌症率
   - 相关性分析

5. **建议与注意事项**
   - 模型性能说明
   - 后续建议
   - 免责声明

6. **技术细节**
   - 模型信息
   - 数据处理流程

---

## 🔧 配置选项

编辑 `examples/935k_zero_shot_inference.py` 中的配置：

```python
# 路径配置
RAW_935K_DATA_PATH = "./data/935k_samples.csv"  # 您的CSV文件路径
RESULTS_DIR = "./results/935k_predictions"       # 结果保存目录

# 模型配置
MAX_INPUT_LENGTH = 30000  # 最大输入长度（935k可能需要更大）
```

---

## 📚 相关文档

- **数据格式指南**: `docs/935k_data_format_guide.md`
  - CSV格式详细要求
  - 数据预处理建议
  - 常见问题解答

- **零样本推理指南**: `docs/935k_zero_shot_inference_guide.md`
  - 可用的预训练模型
  - 使用方法和最佳实践
  - 性能优化建议

- **微调准备指南**: `docs/935k_platform_preparation_guide.md`
  - 如何微调模型以获得更好性能
  - 数据准备和配置

---

## 🛠️ 工具脚本

### 1. 数据验证脚本
```bash
python examples/validate_935k_data.py ./data/935k_samples.csv
```

### 2. 可视化脚本（仅生成图表）
```bash
python examples/visualize_results.py
```
适用于已有预测结果，只需重新生成可视化的情况。

---

## ⚠️ 常见问题

### Q1: CSV文件很大，读取很慢怎么办？

**A:** 脚本会自动将CSV转换为Arrow格式，后续处理会更快。转换后的文件保存为 `935k_samples.arrow`。

### Q2: 列名不是CpG ID格式怎么办？

**A:** 请参考 `docs/935k_data_format_guide.md` 中的列名映射方法。

### Q3: Beta值不在0-1范围怎么办？

**A:** 如果是M值，需要先转换为Beta值：
```python
beta = 2**M / (1 + 2**M)
```

### Q4: 缺失值很多怎么办？

**A:** 可以用中位数或均值填补：
```python
df.fillna(df.median(), inplace=True)
```

### Q5: 如何只可视化已有结果？

**A:** 使用独立的可视化脚本：
```bash
python examples/visualize_results.py
```

---

## 💡 最佳实践

1. **先验证，再推理**
   ```bash
   python examples/validate_935k_data.py ./data/935k_samples.csv
   python examples/935k_zero_shot_inference.py
   ```

2. **小规模测试**
   - 先用少量样本（如10个）测试流程
   - 确认无误后再处理全部数据

3. **保留原始数据**
   - 脚本不会修改原始CSV文件
   - Arrow转换文件会自动生成

4. **检查结果**
   - 查看HTML报告中的统计信息
   - 关注高风险样本
   - 如有真实标签，计算预测准确性

5. **考虑微调**
   - 如果零样本性能不满意
   - 收集50-100个带标签样本
   - 参考微调准备指南

---

## 📞 获取帮助

如有问题，请：
1. 查看相关文档（`docs/` 目录）
2. 运行数据验证脚本检查数据格式
3. 查看脚本输出的错误信息
4. 提交GitHub Issue

---

## 🎉 示例工作流程

完整的工作流程示例：

```bash
# 1. 准备数据
cp /path/to/your/data.csv ./data/935k_samples.csv

# 2. 验证数据
python examples/validate_935k_data.py ./data/935k_samples.csv

# 3. 运行推理
python examples/935k_zero_shot_inference.py

# 4. 查看报告
open results/935k_predictions/analysis_report.html

# 5. （可选）重新生成可视化
python examples/visualize_results.py
```

---

## 📊 示例输出

**终端输出：**
```
================================================================================
步骤1: 环境设置
================================================================================
✓ 设置随机种子: 42

================================================================================
步骤2: 下载依赖和模型
================================================================================
下载DNA嵌入依赖...
  ✓ DNA嵌入依赖已下载

下载预训练模型...
  ✓ 年龄预测模型 (age_cot) 已下载
  ✓ 癌症预测模型 (cancer) 已下载

================================================================================
步骤3: 数据预处理
================================================================================
检测到CSV格式，正在转换为Arrow格式...
  ✓ 加载CSV数据: 100 行 x 935001 列
  ✓ 已转换为Arrow格式: ./data/935k_samples.arrow

...

================================================================================
步骤7: 生成可视化分析图表
================================================================================
生成年龄分布图...
  ✓ 年龄分布图已保存: ./results/935k_predictions/figures/age_distribution.png
生成癌症分布图...
  ✓ 癌症分布图已保存: ./results/935k_predictions/figures/cancer_distribution.png
...

================================================================================
✅ 零样本推理完成！
================================================================================

📁 所有结果已保存到: ./results/935k_predictions
📊 数据文件: ...
📈 可视化图表: ...
📄 分析报告: ./results/935k_predictions/analysis_report.html

💡 提示: 在浏览器中打开 analysis_report.html 查看完整的交互式分析报告
```

---

祝您使用愉快！🎉

