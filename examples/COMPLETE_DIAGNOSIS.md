# 完整诊断报告

## 📊 数据格式检查

### ✅ 输入数据（原始）

**文件**: `data/Sample-251107-Rico-1.arrow`

```
样本数量: 1
总列数: 16,384
数据形状: (1, 16384)
列格式: ['sample_id', 'cg00000029', 'cg00000109', ...]
数据类型: float64 (16,333列), int64 (50列), object (1列)
缺失值: 0 (0.00%)
```

**状态**: ✅ **格式正确**
- 有 `sample_id` 列
- 有 CpG 位点列（cg开头）
- Beta值范围应该在 0-1 之间
- 无缺失值

---

### ✅ 处理后的数据

**目录**: `results/935k_enhanced_predictions/processed/`

```
数据形状: [7, 929,770]
  - 样本数: 7
  - CpG位点数: 929,770

样本ID:
  1. 007012
  2. 000383
  3. 000457
  4. 000399
  5. 000698
  6. 000699
  7. 000700

物种: homo_sapiens
NaN值: 13,490 (0.21%)
```

**状态**: ✅ **处理正确**
- 7个样本都被正确处理
- CpG位点数量: 929,770（接近935k芯片的预期）
- 缺失值比例很低（0.21%）

---

## 🔍 模型配置检查

### 模型参数

**文件**: `dependencies/model/config/age_cot.yaml`

```yaml
model:
  net:
    d_embedding: 128
    d_hidden: 128
    d_dna_embedding: 1024
    n_attention_heads: 8
    n_layers: 8
    architecture: transformer
    use_condition_decoder: true
    condition_size: 1  # ← 这是关键！
  
  training:
    condition_decoder_loss: mae  # ← 使用MAE损失
    loss_weights:
      condition_loss: 0.1
```

**关键发现**:
- `condition_size: 1` - 模型输出是**单个值**（年龄）
- `condition_decoder_loss: mae` - 使用平均绝对误差损失
- 这意味着模型输出的是**回归值**，不是标准化值

---

## ⚠️ 问题分析

### 问题1：预测值缺乏区分度

**现象**:
```
预测值范围: 44.75 - 51.17岁（跨度6.4岁）
实际年龄范围: 26 - 80岁（跨度54岁）
预测值标准差: 2.42岁
实际值标准差: 16.5岁
标准差比率: 14.68%
```

**可能原因**:

#### 原因1：模型训练数据分布问题 ⭐⭐⭐（最可能）

模型可能是在**特定年龄范围**的数据上训练的（如40-60岁的成年人），导致：
- 对训练范围内的年龄预测较准确
- 对训练范围外的年龄（如26岁、80岁）预测不准确
- 所有预测都向训练数据的均值回归

**证据**:
- 预测均值48岁，接近成年人平均年龄
- 26岁预测46岁，80岁预测48岁
- 都向48岁左右回归

#### 原因2：模型过拟合或欠拟合 ⭐⭐

模型可能：
- 没有学到足够的年龄相关特征
- 过度依赖某些特定的CpG位点
- 训练不充分

#### 原因3：数据预处理不匹配 ⭐

你的数据可能与模型训练数据的预处理方式不同：
- 不同的归一化方法
- 不同的背景校正
- 不同的批次效应校正

---

### 问题2：癌症预测全部为阳性

**现象**:
```
所有样本癌症概率: 100%
实际癌症比例: 14.3% (1/7)
准确率: 14.3%
```

**可能原因**:

#### 原因1：阈值设置问题 ⭐⭐⭐（最可能）

癌症模型的输出可能是**logit值**（未经sigmoid转换），导致：
- 所有logit值都很大（7.9-9.0）
- 经过sigmoid后都接近1.0
- 阈值可能设置不当

**证据**:
```
cancer_logit: 7.914 - 8.984
cancer_probability: 0.9995 - 1.0
```

#### 原因2：模型训练数据不平衡 ⭐⭐

模型可能在**癌症样本为主**的数据集上训练，导致：
- 倾向于预测所有样本为癌症
- 对健康样本的识别能力差

#### 原因3：数据类型不匹配 ⭐

你的数据可能是：
- 血液样本，但模型在组织样本上训练
- 不同的组织类型
- 不同的疾病类型

---

## 💡 解决方案

### 方案1：检查模型训练数据分布（推荐）⭐⭐⭐

**步骤**:
1. 查看模型文档，了解训练数据的年龄分布
2. 如果模型是在40-60岁数据上训练的，那么对26岁和80岁的预测不准是正常的
3. 考虑使用其他模型或重新训练

**如何验证**:
- 用40-60岁的样本测试，看预测是否更准确
- 如果是，说明模型确实有年龄范围限制

---

### 方案2：调整癌症预测阈值

**步骤**:
1. 不使用固定阈值0.5
2. 根据你的数据集调整阈值
3. 或者直接使用概率值，不做二分类

**代码示例**:
```python
# 不使用固定阈值
cancer_prob = predictions['cancer_probability']

# 使用相对排序
high_risk = cancer_prob > cancer_prob.median()
```

---

### 方案3：使用其他验证方法

**步骤**:
1. 使用经典的Horvath Clock验证你的数据
2. 对比CpGPT和Horvath的预测结果
3. 如果Horvath也不准，说明数据本身有问题

**工具**:
- R包: `methylclock`
- 在线工具: DNA Methylation Age Calculator

---

## 📋 建议的下一步

### 立即行动

1. **验证数据质量**
   ```bash
   # 检查Beta值范围
   python check_beta_values.py
   ```

2. **测试年龄范围**
   - 用40-60岁的样本测试
   - 看预测是否更准确

3. **调整癌症阈值**
   - 不使用0.5的固定阈值
   - 使用相对排序

### 长期改进

1. **收集更多数据**
   - 不同年龄段的样本
   - 已知癌症状态的样本

2. **重新训练模型**
   - 在你的数据集上fine-tune
   - 或者从头训练

3. **使用集成方法**
   - 结合多个模型的预测
   - 提高准确性

---

## 🎯 结论

### 数据格式
✅ **完全正确** - 数据格式符合要求，处理正常

### 模型问题
⚠️ **可能的训练数据分布限制**
- 模型可能在特定年龄范围训练
- 对极端年龄（26岁、80岁）预测不准
- 这是**模型本身的限制**，不是你的数据问题

### 癌症预测
⚠️ **阈值或训练数据问题**
- 所有样本都被预测为癌症
- 可能需要调整阈值或使用其他模型

### 最终建议
1. ✅ 你的数据格式是正确的
2. ⚠️ 模型可能有年龄范围限制
3. 💡 建议用40-60岁的样本测试
4. 💡 考虑使用其他模型验证
5. 💡 调整癌症预测阈值

---

## 📞 需要帮助？

如果你想：
1. 验证数据质量 → 运行 `python check_data_quality.py`
2. 测试不同年龄范围 → 提供40-60岁的样本
3. 调整癌症阈值 → 我可以帮你修改代码
4. 使用其他模型 → 我可以推荐替代方案

